-- This file is autogenerated from regen-schema.ts

CREATE TABLE IF NOT EXISTS user_contract_views (
  card_views bigint DEFAULT 0 NOT NULL CONSTRAINT user_contract_views_card_views_check CHECK ((card_views >= 0)),
  contract_id text NOT NULL,
  id bigint PRIMARY KEY GENERATED ALWAYS AS IDENTITY NOT NULL,
  last_card_view_ts timestamp with time zone,
  last_page_view_ts timestamp with time zone,
  last_promoted_view_ts timestamp with time zone,
  page_views bigint DEFAULT 0 NOT NULL CONSTRAINT user_contract_views_page_views_check CHECK ((page_views >= 0)),
  promoted_views bigint DEFAULT 0 NOT NULL CONSTRAINT user_contract_views_promoted_views_check CHECK ((promoted_views >= 0)),
  user_id text,
  CONSTRAINT user_contract_views_check CHECK ((((promoted_views + card_views) + page_views) > 0)),
  CONSTRAINT user_contract_views_check1 CHECK (((last_page_view_ts IS NOT NULL) OR (last_card_view_ts IS NOT NULL) OR (last_promoted_view_ts IS NOT NULL)))
);



-- Row Level Security
ALTER TABLE user_contract_views ENABLE ROW LEVEL SECURITY;
-- Policies
DROP POLICY IF EXISTS "self and admin read" ON user_contract_views;
CREATE POLICY "self and admin read" ON user_contract_views FOR SELECT USING (((user_id = firebase_uid()) OR is_admin(firebase_uid()))) ;

-- Indexes
DROP INDEX IF EXISTS user_contract_views_contract_id;
CREATE INDEX user_contract_views_contract_id ON public.user_contract_views USING btree (contract_id, user_id);
DROP INDEX IF EXISTS user_contract_views_pkey;
CREATE UNIQUE INDEX user_contract_views_pkey ON public.user_contract_views USING btree (id);
DROP INDEX IF EXISTS user_contract_views_user_contract_ts;
CREATE INDEX user_contract_views_user_contract_ts ON public.user_contract_views USING btree (user_id, contract_id) INCLUDE (last_page_view_ts, last_promoted_view_ts, last_card_view_ts);
DROP INDEX IF EXISTS user_contract_views_user_id;
CREATE UNIQUE INDEX user_contract_views_user_id ON public.user_contract_views USING btree (user_id, contract_id) NULLS NOT DISTINCT;

