-- This file is autogenerated from regen-schema.ts

CREATE OR REPLACE VIEW final_pp_balances AS
 SELECT txns.from_id AS user_id,
    txns.amount
   FROM txns
  WHERE ((txns.category = 'CONSUME_SPICE'::text) AND (((txns.data -> 'data'::text) ->> 'isLast'::text) IS NOT NULL));

CREATE OR REPLACE VIEW group_role AS
 SELECT gm.member_id,
    gp.id AS group_id,
    gp.name AS group_name,
    gp.slug AS group_slug,
    gp.creator_id,
    gp.total_members,
    users.name,
    users.username,
    (users.data ->> 'avatarUrl'::text) AS avatar_url,
    gm.role,
    ts_to_millis(gm.created_time) AS createdtime,
    gp.privacy_status
   FROM ((group_members gm
     JOIN groups gp ON ((gp.id = gm.group_id)))
     JOIN users ON ((users.id = gm.member_id)));

CREATE OR REPLACE VIEW user_league_info AS
 SELECT leagues.season,
    leagues.division,
    leagues.cohort,
    leagues.user_id,
    leagues.mana_earned,
    leagues.created_time,
    leagues.mana_earned_breakdown,
    leagues.rank_snapshot,
    (row_number() OVER (PARTITION BY leagues.season, leagues.division, leagues.cohort ORDER BY leagues.mana_earned DESC))::integer AS rank
   FROM leagues;

CREATE OR REPLACE VIEW user_referrals_profit AS
 SELECT subquery.id,
    subquery.total_referrals,
    subquery.total_referred_profit,
    subquery.total_referred_cash_profit,
    rank() OVER (ORDER BY subquery.total_referrals DESC) AS rank
   FROM ( SELECT referrer.id,
            count(*) AS total_referrals,
            sum((((uphl.balance + uphl.spice_balance) + uphl.investment_value) - uphl.total_deposits)) AS total_referred_profit,
            sum(((uphl.cash_balance + uphl.cash_investment_value) - uphl.total_cash_deposits)) AS total_referred_cash_profit
           FROM ((users referred
             JOIN users referrer ON ((referrer.id = (referred.data ->> 'referredByUserId'::text))))
             JOIN user_portfolio_history_latest uphl ON ((referred.id = uphl.user_id)))
          WHERE ((referred.data ->> 'referredByUserId'::text) IS NOT NULL)
          GROUP BY referrer.id) subquery
  ORDER BY subquery.total_referrals DESC;

